notion_upsert_by_url(){ local url="$1" title="$2" sel="${3:-未分類}" sum="${4:-}" date="${5:-$(date +%F)}"; local DB="$NOTION_DATABASE_ID" API="$NOTION_API_KEY" VER="${NOTION_VERSION:-2022-06-28}"; local q res id json;
q="$(jq -n --arg url "$url" --arg prop "$NOTION_PROP_URL" '{filter:{property:$prop,url:{equals:$url}},page_size:1}')";
res="$(curl -sS -X POST "https://api.notion.com/v1/databases/$DB/query" -H "Authorization: Bearer $API" -H "Notion-Version: $VER" -H "Content-Type: application/json" -d "$q")";
id="$(printf '%s' "$res"|jq -r '.results[0]?.id//empty')";
json="$(jq -n --arg tprop "$NOTION_PROP_TITLE" --arg uprop "$NOTION_PROP_URL" --arg sprop "$NOTION_PROP_SELECT" --arg mprop "$NOTION_PROP_SUMMARY" --arg dprop "$NOTION_PROP_DATE" --arg t "$title" --arg u "$url" --arg s "$sel" --arg m "$sum" --arg d "$date" '{properties:{($tprop):{title:[{text:{content:$t}}]},($uprop):{url:$u},($sprop):{select:{name:$s}},($mprop):{rich_text:[{text:{content:$m}}]},($dprop):{date:{start:$d}}}}')";
if [ -n "$id" ]; then curl -sS -X PATCH "https://api.notion.com/v1/pages/$id" -H "Authorization: Bearer $API" -H "Notion-Version: $VER" -H "Content-Type: application/json" -d "$json"|jq -r --arg id "$id" '"UPDATED\t\($id)\t\(.last_edited_time//"-")"'; else jq -n --arg db "$DB" --argjson props "$json" '{parent:{database_id:$db}}+$props'>/tmp/n.json; curl -sS -X POST "https://api.notion.com/v1/pages" -H "Authorization: Bearer $API" -H "Notion-Version: $VER" -H "Content-Type: application/json" --data-binary @/tmp/n.json|jq -r '"CREATED\t\(.id)\t\(.created_time//"-")"'; fi; }
